{% extends 'servicehub_app/base.html' %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">My Service History</h2>
            <p class="text-muted">Track your bookings and support local pros.</p>
        </div>
        <a href="{% url 'home' %}" class="btn btn-primary rounded-pill px-4 shadow-sm">
            <i class="bi bi-search me-2"></i>Find More Services
        </a>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 p-3 bg-white text-center">
                <div class="text-primary fs-1 mb-2"><i class="bi bi-hash"></i></div>
                <h6 class="text-muted small text-uppercase fw-bold">Total Bookings</h6>
                <h3 class="fw-bold mb-0" id="total-count">0</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 p-3 bg-white text-center">
                <div class="text-success fs-1 mb-2"><i class="bi bi-wallet2"></i></div>
                <h6 class="text-muted small text-uppercase fw-bold">Total Spent</h6>
                <h3 class="fw-bold mb-0 text-success">KES <span id="total-spent">0</span></h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 p-3 bg-white text-center">
                <div class="text-info fs-1 mb-2"><i class="bi bi-people"></i></div>
                <h6 class="text-muted small text-uppercase fw-bold">Worker Share (90%)</h6>
                <h3 class="fw-bold mb-0 text-info">KES <span id="total-payouts">0</span></h3>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-muted small fw-bold text-uppercase">Provider</th>
                        <th class="py-3 text-muted small fw-bold text-uppercase">Service Date</th>
                        <th class="py-3 text-muted small fw-bold text-uppercase">Total Fee</th>
                        <th class="py-3 text-muted small fw-bold text-uppercase">Status</th>
                        <th class="pe-4 py-3 text-muted small fw-bold text-uppercase text-end">Details</th>
                    </tr>
                </thead>
                <tbody id="bookings-table-body">
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Loading your history...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
    <div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0">
                <h5 class="fw-bold">Rate Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <p class="text-muted">How was your experience with <strong id="modal-provider-name"></strong>?</p>

                <div class="mb-3" id="star-rating-input" style="font-size: 2.5rem;">
                    <i class="bi bi-star rating-star px-1" data-value="1" style="cursor:pointer; color: #ffc107;"></i>
                    <i class="bi bi-star rating-star px-1" data-value="2" style="cursor:pointer; color: #ffc107;"></i>
                    <i class="bi bi-star rating-star px-1" data-value="3" style="cursor:pointer; color: #ffc107;"></i>
                    <i class="bi bi-star rating-star px-1" data-value="4" style="cursor:pointer; color: #ffc107;"></i>
                    <i class="bi bi-star rating-star px-1" data-value="5" style="cursor:pointer; color: #ffc107;"></i>
                </div>

                <input type="hidden" id="selected-rating" value="0">
                <input type="hidden" id="target-provider" value="">
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary w-100 rounded-pill py-2" onclick="submitRating()">Submit Review</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/my-bookings/')
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById('bookings-table-body');
            const countEl = document.getElementById('total-count');
            const spentEl = document.getElementById('total-spent');
            const payoutEl = document.getElementById('total-payouts');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted">No bookings found yet.</td></tr>`;
                return;
            }

            let totalSpent = 0;

            tbody.innerHTML = data.map(b => {
                // FIX: If total_fee is null/None, treat it as 0 for the math
                const fee = parseFloat(b.total_amount) || 0;
                totalSpent += fee;

                let badgeClass = 'bg-warning text-dark';
                if (b.status.toLowerCase() === 'completed') badgeClass = 'bg-success';
                if (b.status.toLowerCase() === 'cancelled') badgeClass = 'bg-danger';
                if (b.status.toLowerCase() === 'in progress') badgeClass = 'bg-info text-dark';

                // Display "Pending" if fee is 0
                const displayFee = fee > 0 ? `KES ${fee.toLocaleString()}` : `<span class="text-muted small">Pending Quote</span>`;

                return `
                    <tr>
                        <td class="ps-4"><strong>${b.provider}</strong></td>
                        <td>${b.date}</td>
                        <td>${displayFee}</td>
                        <td><span class="badge ${badgeClass}">${b.status}</span></td>
                        <td class="pe-4 text-end">
                            ${b.status.toLowerCase() === 'completed'
                                ? `<button onclick="openRateModal('${b.provider}')" class="btn btn-sm btn-warning rounded-pill px-3">
                                    <i class="bi bi-star-fill me-1"></i>Rate
                                   </button>`
                                : `<small class="text-muted italic">In Progress</small>`
                            }
                        </td>
                    </tr>`;
            }).join('');

            // Update the Top Stats with formatted numbers
            countEl.innerText = data.length;
            spentEl.innerText = totalSpent.toLocaleString(undefined, {minimumFractionDigits: 2});
            payoutEl.innerText = (totalSpent * 0.9).toLocaleString(undefined, {minimumFractionDigits: 2});
        })
        .catch(err => {
            console.error("Error:", err);
            document.getElementById('bookings-table-body').innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Error loading data.</td></tr>`;
        });
});

let ratingModal;
document.addEventListener('DOMContentLoaded', () => {
    ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
});

function openRateModal(username) {
    document.getElementById('modal-provider-name').innerText = username;
    document.getElementById('target-provider').value = username;
    ratingModal.show();
}

// Handle star clicking interaction
document.querySelectorAll('.rating-star').forEach(star => {
    star.addEventListener('click', function() {
        const val = this.getAttribute('data-value');
        document.getElementById('selected-rating').value = val;

        // Highlight stars
        document.querySelectorAll('.rating-star').forEach(s => {
            s.classList.replace('bi-star-fill', 'bi-star');
            if(s.getAttribute('data-value') <= val) {
                s.classList.replace('bi-star', 'bi-star-fill');
                s.classList.add('text-warning');
            }
        });
    });
});


document.querySelectorAll('.rating-star').forEach(star => {
    star.addEventListener('click', function() {
        const val = parseInt(this.getAttribute('data-value'));
        document.getElementById('selected-rating').value = val;

        // Highlight stars
        document.querySelectorAll('.rating-star').forEach(s => {
            const starValue = parseInt(s.getAttribute('data-value'));
            if (starValue <= val) {
                // Turn into filled star
                s.classList.remove('bi-star');
                s.classList.add('bi-star-fill');
            } else {
                // Turn into empty star
                s.classList.remove('bi-star-fill');
                s.classList.add('bi-star');
            }
        });
    });
});
function submitRating() {
    const stars = document.getElementById('selected-rating').value;
    const username = document.getElementById('target-provider').value;

    if(stars == 0) return alert("Please select a star rating.");

    fetch('/api/submit-rating/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 'provider_username': username, 'stars': stars })
    })
    .then(res => res.json())
    .then(data => {
        ratingModal.hide();
        location.reload();
    });
}
</script>
{% endblock %}